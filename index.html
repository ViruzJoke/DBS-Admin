<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DHL Backup Solution - Home</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
	<link rel="icon" href="DBS_Icon2.jpg" type="image/jpg">
    <style>
        /* เพิ่มสไตล์สำหรับแสดงผล Error */
        .tracking-error-box {
            background-color: #fef2f2; /* red-50 */
            border: 1px solid #fecaca; /* red-200 */
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .dark-mode .tracking-error-box {
            background-color: #451a1a;
            border-color: #991b1b;
        }
    </style>
</head>
<body>
    <header class="bg-white shadow-md py-4 px-6 md:px-10 flex justify-between items-center relative z-10 rounded-b-xl">
         <a href="index.html" class="flex items-center"><span class="text-4xl font-bold text-red-600">DHL</span><span class="ml-2 text-xl font-semibold text-gray-800 sm:block">Backup Solution</span></a>
        <nav id="desktop-utilities-nav" class="flex items-center space-x-2 sm:space-x-4">
            <div class="relative">
                <button id="language-toggle-button" class="utility-button px-4 py-2 flex items-center gap-2"><span id="current-language-display"></span><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></button>
                <div id="language-dropdown" class="language-dropdown absolute right-0 mt-2 w-28 bg-white rounded-md shadow-lg hidden z-20">
                    <a href="#" class="block px-4 py-2" data-lang="th">ภาษาไทย</a><a href="#" class="block px-4 py-2" data-lang="en">English</a>
                </div>
            </div>
            <button id="theme-toggle" class="utility-button">
                <svg id="theme-icon-light" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                <svg id="theme-icon-dark" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
            </button>
        </nav>
    </header>

    <main class="container py-8">
        <section id="corporate-page">
            <section id="tracking-section" class="relative bg-cover bg-center h-80 flex flex-col items-center justify-center text-white text-center rounded-xl my-8 shadow-lg" style="background-image: url(https://placehold.co/1200x400/FFCC00/CC0000?text=TRACK+YOUR+SHIPMENT);">
                <div class="absolute inset-0 bg-black opacity-50 rounded-xl"></div>
                <div class="relative z-10 p-4 w-full max-w-xl">
                    <h2 class="text-4xl md:text-5xl font-extrabold mb-4" data-i18n="trackYourPackageTitle"></h2>
                    <p class="text-lg mb-6" data-i18n="enterTrackingNumber"></p>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <textarea id="tracking-number-input" class="input-field w-full sm:flex-grow px-5 py-3 rounded-md text-gray-800 resize-none" rows="1" data-i18n-placeholder="enterTrackingNumberPlaceholder"></textarea>
                        <button id="track-button" class="btn-primary btn-red w-full sm:w-auto mt-2 sm:mt-0" data-i18n="trackButton"></button>
                    </div>
                    <div id="tracking-result" class="mt-4 p-3 bg-white text-black rounded-lg shadow-md hidden"></div>
                </div>
            </section>
            
            <section class="card my-8">
                <h2 class="text-3xl font-extrabold text-center text-gray-800 mb-8" data-i18n="gettingStartedTitle"></h2>
                <div class="flex flex-col md:flex-row justify-center gap-6 max-w-3xl mx-auto">
                    <a href="quote.html" class="main-action-button bg-yellow-500 text-black hover:bg-yellow-600">
                        <svg class="w-14 h-14 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 7h6m-3 4h.01M12 15h.01M12 11h.01M16 11h.01M16 15h.01M8 15h.01M8 11h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <span data-i18n="calculateQuote"></span>
                    </a>
                    <a href="ship.html" class="main-action-button bg-yellow-500 text-black hover:bg-yellow-600">
                        <svg class="w-14 h-14 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 8.25V17.25H19V8.25L12 3L5 8.25Z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 8.25L12 13.5L5 8.25"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 13.5V21"></path></svg>
                        <span data-i18n="createShipment"></span>
                    </a>
                </div>
            </section>

            <section id="contact-info-section" class="card my-8">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-4" data-i18n="emergencyOnlyTitle"></h2>
                <p class="text-center text-gray-700 max-w-2xl mx-auto" data-i18n="emergencySystemMessage"></p>
            </section>
        </section>

        <section id="tracking-display-page" class="hidden-page card max-w-4xl mx-auto">
             <h2 class="text-3xl font-extrabold text-gray-800 text-center mb-8" data-i18n="multiTrackingResultTitle"></h2>
             <div id="tracking-content" class="space-y-4"></div>
             <button type="button" id="tracking-back-to-main" class="mt-8 w-full btn-primary btn-gray" data-i18n="backToMain"></button>
        </section>
    </main>
    <footer class="bg-gray-800 text-white py-8 mt-8"><div class="text-center text-sm text-gray-400">&copy; <span id="current-year"></span> DHL Express. <span data-i18n="allRightsReserved"></span></div></footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const translations = { 'th': { 'homepage': 'หน้าหลัก', 'trackYourPackageTitle': 'ติดตามพัสดุของคุณ', 'enterTrackingNumber': 'ป้อนหมายเลขติดตามพัสดุได้สูงสุด 10 หมายเลข โดยคั่นด้วยเครื่องหมายจุลภาค (,) หรือขึ้นบรรทัดใหม่', 'trackButton': 'ติดตาม', 'gettingStartedTitle': 'เริ่มต้นใช้งาน', 'calculateQuote': 'คำนวณค่าขนส่ง', 'createShipment': 'สร้างใบนำส่ง', 'allRightsReserved': 'สงวนลิขสิทธิ์.', 'enterTrackingNumberPlaceholder': 'กรอกหมายเลขติดตามพัสดุ', 'emergencyOnlyTitle': 'เฉพาะกรณีฉุกเฉิน', 'emergencySystemMessage': 'ระบบนี้จะถูกเปิดใช้งานในกรณีที่ระบบ MyDHL+ ไม่สามารถใช้งานได้เท่านั้น หากระบบ MyDHL+ สามารถกลับมาใช้งานได้ปกติแล้ว ระบบนี้จะถูกระงับใช้ภายใน 30 นาที ขอบคุณที่ใช้บริการ DHL Express', 'trackingDetailsTitle': 'รายละเอียดการจัดส่ง', 'multiTrackingResultTitle': 'ผลการติดตามพัสดุ', 'trackingNumberDisplay': 'หมายเลขติดตามพัสดุ:', 'status': 'สถานะ:', 'origin': 'ต้นทาง:', 'destination': 'ปลายทาง:', 'pieces': 'จำนวนกล่อง:', 'totalWeight': 'น้ำหนักรวม:', 'eventHistory': 'อัพเดทการจัดส่งทั้งหมด', 'eventAt': 'ที่', 'eventOn': 'เมื่อ', 'noEventsFound': 'ไม่พบประวัติเหตุการณ์', 'backToMain': 'กลับหน้าหลัก', 'trackingSimulated': 'กำลังติดตาม...', 'trackingError': 'เกิดข้อผิดพลาด:', 'serverError': 'ไม่สามารถเชื่อมต่อเซิร์ฟเวอร์ได้', 'trackingResultUnexpected': 'ไม่พบข้อมูลการจัดส่ง', 'noValidNumbers': 'กรุณากรอกหมายเลขติดตามพัสดุ 10 หลักที่ถูกต้อง' }, 'en': { 'homepage': 'Home', 'trackYourPackageTitle': 'Track Your Shipment', 'enterTrackingNumber': 'Enter up to 10 tracking numbers, separated by a comma (,) or a new line.', 'trackButton': 'Track', 'gettingStartedTitle': 'Get Started', 'calculateQuote': 'Calculate Quote', 'createShipment': 'Create Shipment', 'allRightsReserved': 'All rights reserved.', 'enterTrackingNumberPlaceholder': 'Enter tracking number(s)', 'emergencyOnlyTitle': 'For Emergency Only', 'emergencySystemMessage': 'This system will be activated only if the MyDHL+ system is unavailable. If MyDHL+ system becomes operational again, this system will be temporarily suspended within 30 minutes. Thank you for using DHL Express.', 'trackingDetailsTitle': 'Shipment Details', 'multiTrackingResultTitle': 'Shipment Tracking Results', 'trackingNumberDisplay': 'Tracking Number:', 'status': 'Status:', 'origin': 'Origin:', 'destination': 'Destination:', 'pieces': 'Piece(s):', 'totalWeight': 'Total Weight:', 'eventHistory': 'All Shipment Updates', 'eventAt': 'at', 'eventOn': 'on', 'noEventsFound': 'No event history found', 'backToMain': 'Back to Main', 'trackingSimulated': 'Tracking...', 'trackingError': 'An error occurred:', 'serverError': 'Could not connect to the server', 'trackingResultUnexpected': 'Shipment information not found', 'noValidNumbers': 'Please enter valid 10-digit tracking numbers.' } };
            let currentLanguage = localStorage.getItem('language') || 'th';
            let lastResultsData = null; 
            function getTranslatedText(key, replacements = {}) { let text = translations[currentLanguage]?.[key] || key; for (const p in replacements) { text = text.replace(`{${p}}`, replacements[p]); } return text; }
            function updateContentLanguage() { document.querySelectorAll('[data-i18n]').forEach(el => { el.textContent = getTranslatedText(el.getAttribute('data-i18n')); }); document.querySelectorAll('[data-i18n-placeholder]').forEach(el => { el.placeholder = getTranslatedText(el.getAttribute('data-i18n-placeholder')); }); document.getElementById('current-language-display').textContent = currentLanguage.toUpperCase(); document.title = `DHL Backup Solution - ${getTranslatedText('homepage')}`; }
            function setupTheme() { const themeToggle = document.getElementById('theme-toggle'); const lightIcon = document.getElementById('theme-icon-light'); const darkIcon = document.getElementById('theme-icon-dark'); const enableDarkMode = () => { document.body.classList.add('dark-mode'); localStorage.setItem('theme', 'dark'); lightIcon.classList.remove('hidden'); darkIcon.classList.add('hidden'); }; const disableDarkMode = () => { document.body.classList.remove('dark-mode'); localStorage.setItem('theme', 'light'); lightIcon.classList.add('hidden'); darkIcon.classList.remove('hidden'); }; themeToggle.addEventListener('click', () => document.body.classList.contains('dark-mode') ? disableDarkMode() : enableDarkMode()); if (localStorage.getItem('theme') === 'dark') { enableDarkMode(); } else { disableDarkMode(); } }
            function setupLanguageSwitch() { document.getElementById('language-toggle-button').addEventListener('click', () => document.getElementById('language-dropdown').classList.toggle('hidden')); document.querySelectorAll('[data-lang]').forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); currentLanguage = e.target.dataset.lang; localStorage.setItem('language', currentLanguage); updateContentLanguage(); if (!trackingDisplayPage.classList.contains('hidden-page') && lastResultsData) { displayMultiTrackingResults(lastResultsData); } document.getElementById('language-dropdown').classList.add('hidden'); }); }); }
            
            const corporatePage = document.getElementById('corporate-page');
            const trackingDisplayPage = document.getElementById('tracking-display-page');

            function displayMultiTrackingResults(data, isError = false, errorData = {}) {
                lastResultsData = data; 
                const contentDiv = document.getElementById('tracking-content');
                
                if (isError) {
                    const errorTitle = errorData.title || 'Error';
                    const errorDetail = errorData.detail || 'An unknown error occurred.';
                    const additionalDetails = errorData.additionalDetails || [];
                    
                    let additionalDetailsHtml = '';
                    if (Array.isArray(additionalDetails) && additionalDetails.length > 0) {
                        additionalDetailsHtml = additionalDetails.map(detail => `<p class="text-sm text-gray-600 dark:text-gray-400 mt-1">${detail}</p>`).join('');
                    }

                    contentDiv.innerHTML = `
                        <div class="tracking-error-box">
                            <h4 class="font-bold text-lg text-red-700 dark:text-red-400">${errorTitle}</h4>
                            <p class="text-red-600 dark:text-red-300 font-semibold mt-1">${errorDetail}</p>
                            <div class="mt-2">${additionalDetailsHtml}</div>
                        </div>`;
                    return;
                }

                const shipments = data.shipments || [];
                if (shipments.length === 0) {
                    contentDiv.innerHTML = `<p class="text-center p-4">${getTranslatedText('trackingResultUnexpected')}</p>`;
                    return;
                }

                contentDiv.innerHTML = shipments.map(shipment => {
                    const trackingNumber = shipment?.shipmentTrackingNumber || 'N/A';
                    const status = shipment?.status || getTranslatedText('trackingResultUnexpected');
                    const shipperLocation = shipment?.shipperDetails?.serviceArea?.[0]?.description || 'N/A';
                    const receiverLocation = shipment?.receiverDetails?.serviceArea?.[0]?.description || 'N/A';
                    const pieceCount = shipment?.numberOfPieces ?? 0;
                    const weightValue = shipment?.totalWeight;
                    const weightUnit = shipment?.unitOfMeasurements?.toLowerCase() === 'metric' ? 'KG' : 'LBS';
                    const totalWeight = weightValue ? `${weightValue} ${weightUnit}` : 'N/A';
                    
                    return `
                        <div class="accordion-item">
                            <button class="accordion-header w-full text-left" aria-expanded="false">
                                <div class="flex flex-col w-full">
                                    <div class="flex justify-between items-center w-full">
                                        <div>
                                            <h4 class="font-bold text-lg">${trackingNumber}</h4>
                                            <p class="accordion-header-info text-green-600 dark:text-green-400 font-semibold">${status}</p>
                                        </div>
                                        <svg class="accordion-arrow w-6 h-6 flex-shrink-0 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                    </div>
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-x-4 gap-y-2 text-sm mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                                        <div><p class="font-semibold">${getTranslatedText('origin')}</p><p class="truncate">${shipperLocation}</p></div>
                                        <div><p class="font-semibold">${getTranslatedText('destination')}</p><p class="truncate">${receiverLocation}</p></div>
                                        <div><p class="font-semibold">${getTranslatedText('pieces')}</p><p>${pieceCount}</p></div>
                                        <div><p class="font-semibold">${getTranslatedText('totalWeight')}</p><p>${totalWeight}</p></div>
                                    </div>
                                </div>
                            </button>
                            <div class="accordion-body"><div class="accordion-body-content">${generateShipmentTimelineHTML(shipment)}</div></div>
                        </div>`;
                }).join('');

                contentDiv.querySelectorAll('.accordion-header').forEach(button => {
                    button.addEventListener('click', () => {
                        const isExpanded = button.getAttribute('aria-expanded') === 'true';
                        button.setAttribute('aria-expanded', !isExpanded);
                        button.querySelector('.accordion-arrow').classList.toggle('rotate-180');
                        const body = button.nextElementSibling;
                        if (!isExpanded) { 
                            body.style.maxHeight = body.scrollHeight + "px"; 
                        } else { 
                            body.style.maxHeight = '0'; 
                        }
                    });
                });
            }

            function generateShipmentTimelineHTML(shipment) {
                if (!shipment?.events || shipment.events.length === 0) {
                    return `<p class="italic p-4">${getTranslatedText('noEventsFound')}</p>`;
                }

                const eventsByDate = (shipment.events).reduce((acc, event) => { 
                    const date = new Date(event.date).toLocaleDateString('en-CA');
                    if (!acc[date]) acc[date] = []; 
                    acc[date].push(event); 
                    return acc; 
                }, {});

                const sortedDates = Object.keys(eventsByDate).sort((a, b) => new Date(b) - new Date(a));
                
                return `
                    <div class="p-4">
                        <h3 class="text-lg font-bold mb-4">${getTranslatedText('eventHistory')}</h3>
                        ${sortedDates.map(date => `
                            <div>
                                <h4 class="timeline-date-header">${new Date(date+'T00:00:00').toLocaleDateString(currentLanguage === 'th' ? 'th-TH' : 'en-GB', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h4>
                                <ul class="tracking-timeline">
                                    ${eventsByDate[date].sort((a, b) => (b.time || '').localeCompare(a.time || '')).map((event, index) => {
                                        const eventTime = event?.time || '';
                                        const eventDescription = event?.description || 'N/A';
                                        const eventLocation = event?.serviceArea?.[0]?.description || '';
                                        
                                        return `
                                        <li class="timeline-item ${index === 0 && date === sortedDates[0] ? 'is-latest' : ''}">
                                            <div class="timeline-icon">
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                                                </svg>
                                            </div>
                                            <div class="timeline-content">
                                                <p class="timeline-timestamp">${eventTime}</p>
                                                <p class="timeline-status">${eventDescription}</p>
                                                <p class="timeline-location">${eventLocation}</p>
                                            </div>
                                        </li>
                                    `}).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>`;
            }
            
            function cleanTrackingNumbers(input) { return input.replace(/[^0-9,\n]/g, '').replace(/[\n\s]+/g, ',').split(',').map(s => s.trim()).filter(s => s.length === 10).filter((item, index, self) => self.indexOf(item) === index).slice(0, 10).join(','); }
            
            document.getElementById('track-button').addEventListener('click', async () => {
                const trackButton = document.getElementById('track-button');
                const trackingInput = document.getElementById('tracking-number-input').value;
                const trackingResultDiv = document.getElementById('tracking-result');
                const cleanedNumbersString = cleanTrackingNumbers(trackingInput);

                if (!cleanedNumbersString) { 
                    trackingResultDiv.textContent = getTranslatedText('noValidNumbers'); 
                    trackingResultDiv.classList.remove('hidden'); 
                    return; 
                }

                trackingResultDiv.textContent = getTranslatedText('trackingSimulated');
                trackingResultDiv.classList.remove('hidden');
                trackButton.disabled = true;

                const showTrackingPage = () => {
                    corporatePage.classList.add('hidden-page');
                    trackingDisplayPage.classList.remove('hidden-page');
                    trackingResultDiv.classList.add('hidden');
                };

                try {
                    const proxyUrl = 'https://corsproxy.io/?';
                    const apiUrl = `${proxyUrl}${encodeURIComponent(`https://dbs-back-viruzjokes-projects.vercel.app/api/track?trackingNumber=${cleanedNumbersString}`)}`;
                    
                    const response = await fetch(apiUrl);
                    const data = await response.json();

                    if (response.ok) {
                        displayMultiTrackingResults(data);
                    } else {
                        displayMultiTrackingResults(null, true, data);
                    }
                    showTrackingPage();

                } catch (error) {
                    // This block catches network errors or JSON parsing errors
                    console.error("Fetch Error:", error);
                    trackingResultDiv.textContent = `${getTranslatedText('trackingError')} ${error.message}`;
                } finally {
                    trackButton.disabled = false;
                }
            });

            document.getElementById('tracking-back-to-main').addEventListener('click', () => {
                trackingDisplayPage.classList.add('hidden-page');
                corporatePage.classList.remove('hidden-page');
                document.getElementById('tracking-number-input').value = '';
                lastResultsData = null;
            });

            document.getElementById('current-year').textContent = new Date().getFullYear();
            setupTheme();
            setupLanguageSwitch();
            updateContentLanguage();
        });
    </script>
</body>
</html>
